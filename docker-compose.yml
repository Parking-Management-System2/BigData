version: "3.8"

services:
    zookeeper:
        image: bitnamilegacy/zookeeper:3.9.1
        environment:
            - ALLOW_ANONYMOUS_LOGIN=yes
        ports:
            - "2181:2181"

    kafka:
        image: bitnamilegacy/kafka:3.7.0
        environment:
            - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
            - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
            - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
            - ALLOW_PLAINTEXT_LISTENER=yes
        ports:
            - "9092:9092"
        depends_on:
            - zookeeper

    postgres:
        image: postgres:15
        environment:
            - POSTGRES_USER=user
            - POSTGRES_PASSWORD=password
            - POSTGRES_DB=churn_db
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data

    backend:
        build:
            context: .
            dockerfile: Dockerfile.backend
        ports:
            - "8000:8000"
        environment:
            - POSTGRES_HOST=postgres
            - POSTGRES_USER=user
            - POSTGRES_PASSWORD=password
            - POSTGRES_DB=churn_db
        depends_on:
            - postgres

    spark-worker:
        build:
            context: .
            dockerfile: Dockerfile.spark
        command: python src/consumer.py
        environment:
            - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
            - POSTGRES_HOST=postgres
            - POSTGRES_USER=user
            - POSTGRES_PASSWORD=password
            - POSTGRES_DB=churn_db
        depends_on:
            - kafka
            - postgres
        volumes:
            - ./data:/app/data
            - ./models:/app/models

    frontend:
        build:
            context: .
            dockerfile: Dockerfile.frontend
        ports:
            - "3000:80"
        depends_on:
            - backend

    # Producer zakomentowany, zeby dane byly generowane tylko przez backend

    # producer:
    #   build:
    #     context: .
    #     dockerfile: Dockerfile.spark
    #   command: python src/producer.py
    #   environment:
    #     - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    #   depends_on:
    #     - kafka
    #   volumes:
    #     - ./data:/app/data

volumes:
    postgres_data:
